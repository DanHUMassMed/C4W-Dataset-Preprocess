<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worcester Dataset Downloader</title>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .header {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            min-width: 220px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .dataset-list {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            max-height: 600px;
            overflow-y: auto;
        }

        .publisher-group {
            border-bottom: 2px solid #e0e0e0;
        }

        .publisher-group:last-child {
            border-bottom: none;
        }

        .publisher-header {
            padding: 15px 20px;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            color: #2c3e50;
            user-select: none;
            transition: background-color 0.2s;
            font-size: 16px;
        }

        .publisher-header:hover {
            background: #e9ecef;
        }

        .publisher-count {
            float: right;
            font-size: 13px;
            color: #6c757d;
            font-weight: normal;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .publisher-content {
            background: white;
            border-top: 1px solid #e0e0e0;
        }


        .dataset-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            align-items: flex-start;
            transition: background-color 0.2s;
        }

        .dataset-item:hover {
            background: #f9f9f9;
        }

        .dataset-item:last-child {
            border-bottom: none;
        }

        .dataset-checkbox {
            margin-right: 15px;
            margin-top: 4px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .dataset-content {
            flex: 1;
        }

        .dataset-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .dataset-title a:hover {
            text-decoration: underline !important;
        }

        .dataset-description {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .selection-count {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>

<body>

    <div class="container">

        <div class="header">
            <h1>Worcester Dataset Downloader</h1>
            <p class="selection-count">No datasets selected</p>
        </div>

        <div class="controls">

            <!-- Search Box -->
            <input type="text" id="searchInput" class="search-input" placeholder="Filter by title..."
                oninput="filterDatasets()">

            <button class="btn-secondary" onclick="selectAll()">Select All</button>
            <button class="btn-secondary" onclick="deselectAll()">Deselect All</button>
            <button class="btn-secondary" id="collapseToggleBtn" onclick="toggleCollapseAll()">Collapse All</button>

            <button class="btn-primary" id="downloadBtn" onclick="downloadSelected()" disabled>
                Download Selected
            </button>

        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Downloading datasets...</p>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <div class="dataset-list" id="datasetList"></div>

    </div>

    <script>

        let datasets = [];
        let allDatasets = [];

        /* ============================
           LOAD CSV
        ============================ */

        async function loadDatasets() {

            const csvPath = 'data/worcester-datasets.csv';
            const fullUrl = `${window.location.origin}/${csvPath}`;

            try {

                const response = await fetch(fullUrl);

                if (!response.ok) {
                    showMessage(
                        `Failed to load CSV (${response.status})`,
                        'error'
                    );
                    return;
                }

                const text = await response.text();

                const lines = text.trim().split('\n');

                if (lines.length < 2) {
                    showMessage('CSV file has no data', 'error');
                    return;
                }

                datasets = lines.slice(1).map((line, index) => {

                    const values = parseCSVLine(line);

                    return {
                        id: index,
                        publisher: values[0] || 'Unknown Publisher',
                        title: values[1] || '',
                        description: values[2] || '',
                        accessURL: values[3] || ''
                    };

                });

                // Sort A â†’ Z by publisher, then title
                datasets.sort((a, b) => {
                    const pubDiff = a.publisher.localeCompare(b.publisher, undefined, { sensitivity: 'base' });
                    if (pubDiff !== 0) return pubDiff;
                    return a.title.localeCompare(b.title, undefined, { sensitivity: 'base' });
                });

                // Save master copy
                allDatasets = [...datasets];

                renderDatasets();

            } catch (err) {

                showMessage(err.message, 'error');

            }
        }


        /* ============================
           CSV PARSER
        ============================ */

        function parseCSVLine(line) {

            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {

                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                }

                else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                }

                else {
                    current += char;
                }

            }

            result.push(current.trim().replace(/^"|"$/g, ''));

            return result;
        }


        /* ============================
           RENDER
        ============================ */

        function renderDatasets() {

            const listEl = document.getElementById('datasetList');

            // Group datasets by publisher
            const grouped = {};
            for (const d of datasets) {
                if (!grouped[d.publisher]) {
                    grouped[d.publisher] = [];
                }
                grouped[d.publisher].push(d);
            }

            // Sort publishers alphabetically
            const sortedPublishers = Object.keys(grouped).sort();

            let html = '';
            for (const pub of sortedPublishers) {
                const pubDatasets = grouped[pub];

                html += `
                <details class="publisher-group" open>
                    <summary class="publisher-header">
                        ${escapeHtml(pub)}
                        <span class="publisher-count">${pubDatasets.length} datasets</span>
                    </summary>
                    <div class="publisher-content">
                        ${pubDatasets.map(d => `
                            <div class="dataset-item">
                                <input
                                    type="checkbox"
                                    class="dataset-checkbox"
                                    id="dataset-${d.id}"
                                    data-url="${d.accessURL}"
                                    data-title="${escapeHtml(d.title)}"
                                    onchange="updateSelectionCount()"
                                >
                                <div class="dataset-content">
                                    <div class="dataset-title">
                                        <a href="${d.accessURL}" target="_blank" rel="noopener noreferrer" style="color: #0066cc; text-decoration: none;">
                                            ${escapeHtml(d.title)}
                                        </a>
                                    </div>
                                    <div class="dataset-description">${escapeHtml(d.description)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </details>
                `;
            }

            listEl.innerHTML = html;
            updateSelectionCount();
        }


        /* ============================
           FILTER
        ============================ */

        function filterDatasets() {

            const query = document
                .getElementById('searchInput')
                .value
                .toLowerCase()
                .trim();

            if (!query) {

                datasets = [...allDatasets];

            } else {

                datasets = allDatasets.filter(d =>
                    d.title.toLowerCase().includes(query)
                );

            }

            renderDatasets();
        }


        /* ============================
           UTILITIES
        ============================ */

        function escapeHtml(text) {

            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;

        }


        function selectAll() {

            document
                .querySelectorAll('.dataset-checkbox')
                .forEach(cb => cb.checked = true);

            updateSelectionCount();

        }


        function deselectAll() {

            document
                .querySelectorAll('.dataset-checkbox')
                .forEach(cb => cb.checked = false);

            updateSelectionCount();

        }

        let isCollapsed = false;

        function toggleCollapseAll() {
            isCollapsed = !isCollapsed;

            const detailsElements = document.querySelectorAll('details.publisher-group');
            detailsElements.forEach(details => {
                if (isCollapsed) {
                    details.removeAttribute('open');
                } else {
                    details.setAttribute('open', '');
                }
            });

            const btn = document.getElementById('collapseToggleBtn');
            btn.textContent = isCollapsed ? 'Expand All' : 'Collapse All';
        }


        function updateSelectionCount() {

            const selected =
                document.querySelectorAll('.dataset-checkbox:checked').length;

            const total = datasets.length;

            const countEl =
                document.querySelector('.selection-count');

            const btn =
                document.getElementById('downloadBtn');


            if (selected === 0) {

                countEl.textContent = 'No datasets selected';
                btn.disabled = true;

            } else {

                countEl.textContent =
                    `${selected} of ${total} datasets selected`;

                btn.disabled = false;

            }
        }


        /* ============================
           DOWNLOAD
        ============================ */

        async function downloadSelected() {

            const checkboxes =
                document.querySelectorAll('.dataset-checkbox:checked');

            if (!checkboxes.length) {
                showMessage('Select at least one dataset', 'error');
                return;
            }

            const selected = Array.from(checkboxes).map(cb => ({
                url: cb.dataset.url,
                title: cb.dataset.title
            }));


            document.getElementById('loading').style.display = 'block';
            document.getElementById('downloadBtn').disabled = true;

            const statusEl = document.getElementById('statusMessage');
            statusEl.style.display = 'block';
            statusEl.className = 'status-message info';
            statusEl.innerHTML = `Starting download of ${selected.length} datasets...<ul id="errorList" style="margin-top:10px; color:#721c24; text-align:left; font-size:13px; font-weight:normal;"></ul>`;

            const loadingText = document.querySelector('#loading p');
            const errorList = document.getElementById('errorList');

            let successful = 0;
            let failed = 0;

            try {
                for (let i = 0; i < selected.length; i++) {
                    const dataset = selected[i];
                    loadingText.textContent = `Downloading ${i + 1} of ${selected.length}: ${dataset.title}...`;

                    try {
                        const response = await fetch('/download', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ datasets: [dataset] })
                        });

                        const result = await response.json();

                        if (response.ok && result.successful === 1) {
                            successful++;
                        } else {
                            failed++;
                            const errorMsg = result.failures?.[0]?.error || result.error || 'Unknown error';
                            errorList.innerHTML += `<li style="margin-left: 20px;">Failed to download "${dataset.title}": ${errorMsg}</li>`;
                        }
                    } catch (err) {
                        failed++;
                        errorList.innerHTML += `<li style="margin-left: 20px;">Network error downloading "${dataset.title}": ${err.message}</li>`;
                    }
                }

                loadingText.textContent = 'Downloading datasets...'; // reset

                statusEl.className = failed ? (successful ? 'status-message info' : 'status-message error') : 'status-message success';
                statusEl.innerHTML = `<strong>Finished!</strong> Downloaded ${successful} of ${selected.length}.` +
                    (failed ? `<ul style="margin-top:10px; color:#721c24; text-align:left; font-size:13px;">${errorList.innerHTML}</ul>` : '');

            } finally {

                document.getElementById('loading').style.display = 'none';
                document.getElementById('downloadBtn').disabled = false;

                // If there are no errors, auto-hide the message after 5 seconds.
                if (failed === 0) {
                    setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
                }

            }

        }


        /* ============================
           STATUS
        ============================ */

        function showMessage(message, type) {

            const el = document.getElementById('statusMessage');

            el.textContent = message;
            el.className = `status-message ${type}`;
            el.style.display = 'block';

            setTimeout(() => {
                el.style.display = 'none';
            }, 5000);

        }


        /* ============================
           INIT
        ============================ */

        loadDatasets();

    </script>

</body>

</html>